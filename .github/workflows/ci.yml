# CI/CD Pipeline for Research Project
# ====================================
# 研究プロジェクトの継続的インテグレーション
#
# Triggers:
#   - Push to main/master branch
#   - Pull requests to main/master
#   - Weekly scheduled run (data source health check)
#   - Manual dispatch

name: Research CI/CD

on:
  push:
    branches: [main, master]
    paths:
      - 'skills/**/*.py'
      - 'tests/**/*.py'
      - '再現用コード/**/*.py'
      - 'requirements*.txt'
      - 'pytest.ini'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main, master]
  schedule:
    # Weekly run on Monday at 9:00 JST (00:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      run_integration_tests:
        description: 'Run integration tests (requires API keys)'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ===========================================
  # Lint and Code Quality
  # ===========================================
  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black mypy

      - name: Run flake8
        run: |
          flake8 skills/user --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 skills/user --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics
        continue-on-error: true

      - name: Check code formatting with black
        run: |
          black --check --diff skills/user || echo "Code formatting issues found (non-blocking)"
        continue-on-error: true

  # ===========================================
  # Unit Tests - Corporate Research Data Hub
  # ===========================================
  test-corporate-data-hub:
    name: Test Corporate Research Data Hub
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock
          pip install pandas numpy requests beautifulsoup4 lxml
          if [ -f skills/user/corporate-research-data-hub/requirements.txt ]; then
            pip install -r skills/user/corporate-research-data-hub/requirements.txt || true
          fi

      - name: Run tests with coverage
        run: |
          cd skills/user/corporate-research-data-hub
          pytest tests/ -v --cov=scripts --cov-report=xml --cov-report=term-missing || exit 0
        continue-on-error: true

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          files: skills/user/corporate-research-data-hub/coverage.xml
          flags: corporate-data-hub
          fail_ci_if_error: false
        continue-on-error: true

  # ===========================================
  # Unit Tests - Strategic Management Research Hub
  # ===========================================
  test-strategic-management-hub:
    name: Test Strategic Management Research Hub
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          pip install pandas numpy scipy scikit-learn statsmodels
          # Skip heavy dependencies for faster CI
          # Full requirements can be installed for integration tests

      - name: Run data integrity tests
        run: |
          cd skills/user/strategic-management-research-hub
          python -m pytest tests/test_data_integrity.py -v || exit 0
        continue-on-error: true

      - name: Run QA system tests
        run: |
          cd skills/user/strategic-management-research-hub
          python -m pytest tests/test_qa_system.py -v || exit 0
        continue-on-error: true

  # ===========================================
  # Integration Tests (Optional - requires API keys)
  # ===========================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-corporate-data-hub, test-strategic-management-hub]
    if: github.event.inputs.run_integration_tests == 'true' || github.event_name == 'schedule'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas numpy

      - name: Run connectivity tests (Scientific Databases)
        run: |
          cd skills/user/scientific-databases
          python tests/test_connectivity.py || echo "Some database connections may be unavailable"
        continue-on-error: true
        timeout-minutes: 10

      - name: Run US Corporate Analytics integration tests
        run: |
          cd skills/user/us-corporate-analytics
          python tests/integration_test.py || echo "Integration tests completed with some issues"
        continue-on-error: true
        timeout-minutes: 15

  # ===========================================
  # Data Source Health Check (Scheduled)
  # ===========================================
  data-source-health:
    name: Data Source Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas

      - name: Check EDINET API availability
        run: |
          python -c "
          import requests
          try:
              r = requests.get('https://disclosure.edinet-fsa.go.jp/api/v1/documents.json?date=2024-01-01&type=2', timeout=30)
              print(f'EDINET API: {\"OK\" if r.status_code == 200 else \"FAILED\"} (Status: {r.status_code})')
          except Exception as e:
              print(f'EDINET API: FAILED ({e})')
          "
        continue-on-error: true

      - name: Check SEC EDGAR availability
        run: |
          python -c "
          import requests
          try:
              r = requests.get('https://data.sec.gov/submissions/CIK0000320193.json',
                             headers={'User-Agent': 'Research contact@example.com'}, timeout=30)
              print(f'SEC EDGAR: {\"OK\" if r.status_code == 200 else \"FAILED\"} (Status: {r.status_code})')
          except Exception as e:
              print(f'SEC EDGAR: FAILED ({e})')
          "
        continue-on-error: true

      - name: Check World Bank API availability
        run: |
          python -c "
          import requests
          try:
              r = requests.get('https://api.worldbank.org/v2/country/JP/indicator/NY.GDP.MKTP.CD?format=json', timeout=30)
              print(f'World Bank API: {\"OK\" if r.status_code == 200 else \"FAILED\"} (Status: {r.status_code})')
          except Exception as e:
              print(f'World Bank API: FAILED ({e})')
          "
        continue-on-error: true

  # ===========================================
  # Summary Report
  # ===========================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test-corporate-data-hub, test-strategic-management-hub]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "==================================="
          echo "CI/CD Pipeline Summary"
          echo "==================================="
          echo "Lint: ${{ needs.lint.result }}"
          echo "Corporate Data Hub Tests: ${{ needs.test-corporate-data-hub.result }}"
          echo "Strategic Management Tests: ${{ needs.test-strategic-management-hub.result }}"
          echo "==================================="

          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.test-corporate-data-hub.result }}" == "failure" ]] || \
             [[ "${{ needs.test-strategic-management-hub.result }}" == "failure" ]]; then
            echo "Some jobs failed. Please review the logs."
            exit 1
          fi
          echo "All critical jobs passed!"
